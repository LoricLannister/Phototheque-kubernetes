name: CI/CD - Phototheque Web

on:
  push:
    branches:
      - loric  # D√©clenche le workflow lorsque des commits sont pouss√©s sur la branche loric

env:
  REGISTRY: docker.io
  IMAGE_NAME: loriclannister/phototheque-web
  KUBE_NAMESPACE: test                  # namespace Kubernetes de test
  DEPLOYMENT_NAME: phototheque-web-deployment

jobs:
  test:
    name: üß™ Run Node.js tests
    runs-on: ubuntu-latest
    services:
      mongo:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'" 
          --health-interval 10s 
          --health-timeout 5s 
          --health-retries 5
    env:
      MONGO_URI: mongodb://localhost:27017/phototheque
      MONGO_TEST_URI: mongodb://localhost:27017/phototheque_test

    steps:
      - name: üß∞ Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üì¶ Install dependencies
        run: npm install

      - name: üß† Clone test database (optional)
        run: npm run clone:testdb

      - name: üßπ Fix permissions
        run: chmod +x ./node_modules/.bin/jest

      - name: üß™ Run tests
        env:
          MONGO_TEST_URI: mongodb://localhost:27017/phototheque_test
        run: npm test

  build-and-deploy:
    name: üöÄ Build & Deploy
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: üß∞ Checkout code
        uses: actions/checkout@v4

      - name: üîê Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: üèóÔ∏è Build Docker image
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
                       -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest .

      - name: üì§ Push Docker image
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: üîê Set up kubeconfig
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: ‚öôÔ∏è Configure kubectl access and update deployed image
        run: |
          echo "${{ secrets.KUBECONFIG_CONTENT }}" > kubeconfig
          export KUBECONFIG=./kubeconfig
          kubectl set image deployment/phototheque-web-deployment phototheque-web=${{ env.IMAGE_NAME }}:latest
          kubectl rollout status deployment/phototheque-web-deployment          

# Ce fichier secret permet √† GitHub d‚Äôacc√©der √† ton cluster K8s de test local
# KUBECONFIG_CONTENT
# kubectl config view --flatten --minify
# Pour √©viter de d√©clencher le pipeline √† chaque micro commit pendant tes tests:
# git commit -m "test ci [skip ci]"
# GitHub ignore automatiquement le workflow si [skip ci] est dans le message.