name: CI/CD - Phototheque Web

on:
  push:
    branches:
      - loric  # DÃ©clenche le workflow lorsque des commits sont poussÃ©s sur la branche loric

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ github.repository }}  # ex: loriclannister/phototheque-web
  KUBE_NAMESPACE: test                  # namespace Kubernetes de test
  DEPLOYMENT_NAME: phototheque-web-deployment

jobs:
  test:
    name: ðŸ§ª Run Node.js tests
    runs-on: ubuntu-latest
    services:
      mongo:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'" 
          --health-interval 10s 
          --health-timeout 5s 
          --health-retries 5
    env:
      MONGO_URI: mongodb://localhost:27017/phototheque
      MONGO_TEST_URI: mongodb://localhost:27017/phototheque_test

    steps:
      - name: ðŸ§° Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ðŸ“¦ Install dependencies
        run: npm install

      - name: ðŸ§  Clone test database (optional)
        run: npm run clone:testdb

      - name: ðŸ§¹ Fix permissions
        run: chmod +x ./node_modules/.bin/jest

      - name: ðŸ§ª Run tests
        env:
          MONGO_TEST_URI: ${{ secrets.MONGO_TEST_URI }}
        run: npm test

  build-and-deploy:
    name: ðŸš€ Build & Deploy
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§° Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: ðŸ—ï¸ Build Docker image
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .

      - name: ðŸ“¤ Push Docker image
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: ðŸ” Set up kubeconfig
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: âš™ï¸ Configure kubectl access
        run: |
          echo "${{ secrets.KUBECONFIG_CONTENT }}" > kubeconfig
          export KUBECONFIG=./kubeconfig

      - name: ðŸš€ Deploy to test namespace
        run: |
          kubectl set image deployment/${{ env.DEPLOYMENT_NAME }} \
            phototheque-web=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            -n ${{ env.KUBE_NAMESPACE }}
          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} -n ${{ env.KUBE_NAMESPACE }}

# Ce fichier secret permet Ã  GitHub dâ€™accÃ©der Ã  ton cluster K8s de test local
# KUBECONFIG_CONTENT
# kubectl config view --flatten --minify
# Pour Ã©viter de dÃ©clencher le pipeline Ã  chaque micro commit pendant tes tests:
# git commit -m "test ci [skip ci]"
# GitHub ignore automatiquement le workflow si [skip ci] est dans le message.